<div dir=auto>

# مقدمه

در این بخش به ایجاد یک تونل بین سرور ایران و سرور خارج می پردازیم.برای انجام تونل راهای مختلفی وجود دارد.راهکاری که در شرایط فعلی پاسخگوی نیاز می باشد روش iptables می باشد.
توجه داشته باشید تمام مراحل تنظیم iptables بر روی سرور ایران صورت می گیرد.در نتیجه دستورات زیر را بر روی سرور ایران اعمال نمایید.

## نصب و راه اندازی iptables

در اکثر توزیع های لینوکس به صورت پیشفرض iptables نصب شده است.اگر بر روی سرور شما نصب نشده است می توانید از طریق دستور زیر ابتدا آن را نصب نمایید.

```bash
sudo apt-get install iptables
```

بعد از این مرحله فعالسازی و تنظیمات iptables را شروع می کنیم
در اینجا مشخص می کنیم هر درخواستی که از طریق ip4 وارد سرور می شود را فوروارد کند

```bash
sysctl net.ipv4.ip_forward=1
```
سپس به کمک دستور زیر مشخص می کنیم هر درخواستی که به پورت `22` سرور ایران وارد می شود بر روی همین سرور فوروارد کند.پورت `22` پورتی می باشد که توسط `ssh` استفاده می شود.شما اگر به صورت دستی پورت پیشفرض را به عدد دیگری تغییر داده اید باید به جای عدد `22` عدد مرتبط به خودتان را قرار دهید.توجه داشته باشید به جای کلمه `ip_iran` باید آدرس آیپی سرور ایران را قرار دهید

```bash
iptables -t nat -A PREROUTING -p tcp --dport 22 -j DNAT --to-destination ip_iran
```
سپس به کمک دستور زیر مشخص می کنیم هر درخواستی به سرور وارد می شود را به سرور خارج فوروارد کند .توجه داشته باشید به جای کلمه `ip_foreign` شما باید آدرس آیپی سرور خارج را قرار دهید.

```bash
iptables -t nat -A PREROUTING -j DNAT --to-destination ip_foreign
```
سپس دستور زیر را وارد می نماییم.

```bash
iptables -t nat -A POSTROUTING -j MASQUERADE
```
و در پایان به کمک دستور زیر می توانیم مشاهده کنیم که تنظیمات به درستی اعمال شده است 

```bash
iptables -L -n -t nat
```

## تکمیلی

شما در مراحل قبل تنظیمات iptables را انجام داده اید ولی در صورتی که سرور ری استارت شود.تنظیمات فوق از بین می رود و باید دوباره اقدام نمایید.برای حل این موضوع می توانید بعد از انجام مراحل فوق مراحل زیر هم انجام دهید که در صورتی که سرور ری استارت شد.سرویس iptables به صورت اتوماتیک به حالت تنظیمات فعلی فعال شود.
ابتدا یک فایل ایجاد نماید

```bash
sudo nano /etc/rc.local
```

سپس کدهای زیر که شامل مراحل قبل می باشد را وارد نمایید.توجه داشته باشید به جای کلمه `ip_iran` آیپی سرور ایران و به جای کلمه `ip_foreign` آیپی سرور خارج قرار دهید.وهمچنین در صورتی که پورت `ssh` را تغییر داده اید.عدد مدنظر را به جای `22` وارد نمایید.


```bash
#! /bin/bash
sysctl net.ipv4.ip_forward=1
iptables -t nat -A PREROUTING -p tcp --dport 22 -j DNAT --to-destination ip_iran
iptables -t nat -A PREROUTING -j DNAT --to-destination ip_foreign
iptables -t nat -A POSTROUTING -j MASQUERADE
exit 0
```
و سپس با فشردن کلید های `ctrl + x` و `y` و `enter` تغییرات را ذخیره کنید.

سپس در پایان دستور زیر را وارد نمایید.

```bash
sudo chmod +x /etc/rc.local
```

</div>
